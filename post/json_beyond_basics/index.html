<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="theme-color" content="#263238">

<meta name="generator" content="Hugo 0.68.3" />

<link rel="apple-touch-icon" href="https://lbarasti.com/images/logo.png">




    <link rel="canonical" href="https://lbarasti.com/post/json_beyond_basics/">
    
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,700" rel="stylesheet">
    
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <title>Crystal JSON beyond the basics - lbarasti&#39;s blog</title>
    
<meta name="description" content="In this article, we&rsquo;ll look at how we can encode and decode Algebraic Data Types (ADTs) in Crystal using the json module and its powerful macros.">

<meta property="og:title" content="Crystal JSON beyond the basics - lbarasti&#39;s blog">
<meta property="og:type" content="article">
<meta property="og:url" content="https://lbarasti.com/post/json_beyond_basics/">
<meta property="og:image" content="https://lbarasti.com/src/json_beyond_basics/header.svg">
<meta property="og:site_name" content="lbarasti&#39;s blog">
<meta property="og:description" content="In this article, we&rsquo;ll look at how we can encode and decode Algebraic Data Types (ADTs) in Crystal using the json module and its powerful macros.">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="lbarasti&#39;s blog">
<meta name="twitter:url" content="https://lbarasti.com/post/json_beyond_basics/">
<meta name="twitter:title" content="Crystal JSON beyond the basics - lbarasti&#39;s blog">
<meta name="twitter:description" content="In this article, we&rsquo;ll look at how we can encode and decode Algebraic Data Types (ADTs) in Crystal using the json module and its powerful macros.">
<meta name="twitter:image" content="https://lbarasti.com/src/json_beyond_basics/header.svg">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"https:\/\/lbarasti.com\/"
    },
    "headline": "Crystal JSON beyond the basics-lbarasti's blog",
    "image": {
      "@type": "ImageObject",
      "url": "https:\/\/lbarasti.com\/src\/json_beyond_basics\/header.svg",
      "height": 800,
      "width": 800
    },
    "datePublished": "2020-09-21T00:17:01JST",
    "dateModified": "2020-09-21T00:17:01JST",
    "author": {
      "@type": "Person",
      "name": "lbarasti's blog"
    },
    "publisher": {
      "@type": "Organization",
      "name": "lbarasti's blog",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/lbarasti.com\/images/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "In this article, we\x26rsquo;ll look at how we can encode and decode Algebraic Data Types (ADTs) in Crystal using the json module and its powerful macros."
  }
</script>


    <style>
html {
  font-size: 18px;
  background-color: rgba(236,239,241,.5);
}

@media (max-width: 768px) {
  html {
    font-size: 15px;
  }
}

body {
  color: #333;
  font-family: 'Roboto Slab','ãƒ’ãƒ©ã‚®ãƒŽè§’ã‚´ Pro W3','Hiragino Kaku Gothic Pro',ãƒ¡ã‚¤ãƒªã‚ª,Meiryo,sans-serif;
  font-feature-settings : "palt";
  font-size: inherit;
  line-height: 1rem;
  margin: 0;
  padding: 0;
}

h1, h2, h3, h4, h5 ,h6 {
  font-size: 1rem;
  font-weight: 700;
  line-height: 1rem;
  margin: 0;
}

hr {
  border: 0;
  border-top: 1px dashed #cfd8dc;
  margin: 1rem 0;
}

p {
  margin: 0;
  line-height: 1rem;
}

a {
  color: #2196f3;
  text-decoration: none;
  transition-duration: .3s;
}

ul, ol {
  margin: 0;
  padding: 0;
}

table {
  border-collapse: collapse;
}

th, td {
  font-size: .8rem;
  padding: .5rem;
}

tr {
  border-bottom: 1px dashed #ddd;
}

/* Layouts */
main,
aside {
  display: block;
}

main { padding: 1rem 0 3rem 0; }
aside.h { padding: 3rem 0; }

main.f,
aside.f {
  background-color: #333;
  border-top: 2px dashed #fff;
  border-bottom: 2px dashed #fff;
}

.l-container {
  position: relative;
  max-width: 68rem;
  margin: 0 auto;
  padding: 0 1rem;
}

.l-container.thin {
  max-width: 44rem;
}

.l-header {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  padding: 1rem 0;
  text-align: center;
}

.l-header .description {
  margin-top: .5rem;
  font-size: .8rem;
}

.l-footer {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  font-size: .6rem;
  font-weight: 700;
  padding: 1rem 0;
}

@media (max-width: 768px) {
  .l-sidebar {
    margin-top: 4rem;
  }
}

.mrow {
  margin: 0 -1rem;
  overflow: hidden;
}

.mcol {
  box-sizing: border-box;
  float: left;
  padding: 0 1rem;
}

.c6 { width: 50%; }
.c4 { width: 33.26323833%; }
.c8 { width: 66.66666%; }

@media (max-width: 768px) {
  .mcol {
    width: 100%;
    float: none;
  }
}

.logo a {
  font-size: 1.4rem;
  line-height: 1.5rem;
  font-weight: 700;
  color: #333;
}

.articles {
  margin: -1rem 0;
  margin-bottom: 1rem;
}

.articles.sm {
  margin: -.5rem 0;
  margin-bottom: 0;
}

article {
  border-radius: 4px;
  overflow: hidden;
}

article.li {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  height: 20rem;
  overflow: hidden;
  margin: 1rem 0;
}

article.li > a {
  display: block;
  color: #333;
}

article.li .inner {
  padding: 1rem;
}

article.li .thumb {
  height: 8rem;
}

article.li .title {
  color: #333;
  font-size: 1.2rem;
  line-height: 1.5rem;
  margin-bottom: .5rem;
}

article.li .summary {
  font-size: .8rem;
  height: 6rem;
  overflow: hidden;
  margin-top: 1rem;
}

article.li .summary::after {
  content: '...';
}

article.lism {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  margin: .5rem 0;
}

article.lism::after {
  content: '';
  display: block;
  clear: both;
}

article.lism > a {
  display: block;
  color: #333;
}

article.lism .inner {
  display: table-cell;
  vertical-align: middle;
  height: 5rem;
  padding: 0 .75rem;
}

article.lism .thumb {
  width: 5rem;
  height: 5rem;
  float: left;
}

article.lism .title {
  font-weight: 700;
  font-size: .8rem;
  margin-bottom: .25rem;
}

article.sn {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  margin-bottom: 1rem;
}

article.sn .thumb {
  height: 20rem;
}

@media (max-width: 768px) {
  article.sn .thumb {
    height: 10rem;
  }
}

article.sn > .article-header,
article.sn > .article-body,
article.sn .article-footer {
  padding: 2rem;
}

article.sn > .article-body {
  padding: 0 2rem;
}

@media (max-width: 768px) {
  article.sn > .article-header,
  article.sn > .article-body,
  article.sn .article-footer {
    padding: 1rem;
  }

  article.sn > .article-body {
    padding: 0 1rem;
  }
}

article.sn > .article-header .title {
  font-size: 1.8rem;
  line-height: 2rem;
  margin-bottom: .5rem;
}

@media (max-width: 768px) {
  article.sn > .article-header .title {
    font-size: 1.4rem;
    line-height: 1.5rem;
  }
}

article.sn > .article-header .facts {
  margin-bottom: 1rem;
}

article.sn > .article-body {
  margin-bottom: 1.5rem;
}

article.sn > .article-body h2 {
  border-bottom: .25rem solid #333;
  font-size: 1.2rem;
  line-height: 1.5rem;
  margin: 1.5rem 0;
  padding: .5rem 0;
}

article.sn > .article-body h3 {
  border-left: .5rem solid #333;
  line-height: 1.5rem;
  margin: 1.5rem 0;
  padding: .125rem .5rem;
}

article.sn > .article-body ul,
article.sn > .article-body ol {
  margin: 1.5rem 0;
  padding-left: 1.5rem;
}

article.sn > .article-body li {
  padding-bottom: .5rem;
  line-height: 1.5rem;
}

article.sn > .article-body li:last-child {
  padding-bottom: 0;
}
article.sn > .article-body p {
  margin: 1rem 0;
  line-height: 1.5rem;
}

article.sn > .article-body strong,
article.sn > .article-body em {
  font-style: normal;
  font-weight: 700;
}

article.sn > .article-body strong {
  box-shadow: 0 -.5rem 0 0 #ffc107 inset;
}

article.sn > .article-body em {
  color: #8bc34a;
}

article.sn > .article-body code,
article.sn > .article-body pre {
  font-family: Menlo, Consolas, monospace;
  font-size: .7rem;
}

article.sn > .article-body pre {
  background-color: #333;
  color: #fff;
  line-height: 1rem;
  margin: 1.5rem -2rem;
  overflow: auto;
}

@media (max-width: 768px) {
  article.sn > .article-body pre {
    margin: 1.5rem -1rem;
  }
}

article.sn > .article-body pre > code {
  display: block;
  padding: 1rem 2rem;
}

@media (max-width: 768px) {
  article.sn > .article-body pre > code {
    padding: 1rem;
  }
}

article.sn > .article-body p code {
  background-color: #eceff1;
  color: #333;
  border-radius: 4px;
  margin: 0 .25rem;
  padding: .375rem;
  white-space: nowrap;
}

article.sn > .article-body blockquote {
  position: relative;
  border-left: .25rem solid #333;
  font-size: .8rem;
  padding: .125rem 1rem;
  margin: 1.5rem 0;
}

@media (max-width: 768px) {
  article.sn > .article-body blockquote {
    font-size: 1rem;
  }
}

article.sn > .article-body blockquote p {
  margin: .5rem 0;
  line-height: 1rem;
}

article.sn > .article-body figure {
  margin: 1.5rem 0;
}

article.sn > .article-body img,
article.sn > .article-body figure img,
article.sn > .article-body figure amp-img {
  box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
  max-width: 100%;
}

article.sn > .article-body figcaption {
  color: #cfd8dc;
  font-size: .8rem;
  font-weight: 700;
  margin-top: .5rem;
}

.facts li {
  display: inline;
  font-size: .8rem;
  margin-right: 1rem;
}

.facts i {
  color: #cfd8dc;
  margin-right: .5em;
}

.facts.sm li {
  font-size: .7rem;
}

.sections.sidebar {
  margin: -1rem 0;
}

.sections.footer {
  margin: -1rem 0;
}

section.sidebar {
  margin: 2rem 0;
}

section.sidebar > header {
  font-size: .8rem;
  font-weight: 700;
  letter-spacing: 4px;
  text-align: center;
  margin: 1.5rem 0;
}

section.footer {
  margin: 1rem 0;
}

section.footer > header {
  font-size: .8rem;
  margin: .5rem 0;
}

section.footer > header::before {
  content: "- ";
}

section.footer > header a {
  font-weight: 700;
  color: #333;
  text-decoration: underline;
}

.terms {
  margin: -.25rem;
}

.terms li {
  display: inline-block;
}

.terms a {
  display: block;
  float: left;
  background-color: #333;
  border-radius: 4px;
  color: #fff;
  font-size: .7rem;
  margin: .25rem;
  padding: 0 .75rem;
  line-height: 1.75rem;
}

.paging {
  text-align: center;
  padding: 1rem 0;
}

.paging a {
  display: inline-block;
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  border-radius: 4px;
  color: #333;
  padding: 0 1rem;
  line-height: 3rem;
}

.page-title {
  text-align: center;
  margin: 1rem 0;
}

.page-title::after {
  content: '';
  display: block;
  border-bottom: .25rem solid #333;
  width: 3rem;
  margin: 1.5rem auto;
}

.page-title > .title {
  font-size: 1.2rem;
  line-height: 1.5rem;
}

/* Parts:breadcrumb */
.crumb ol {
  text-overflow: ellipsis;
  color: #cfd8dc;
  white-space: nowrap;
  overflow: hidden;
}

.crumb li {
  display: inline;
  font-size: .8rem;
}

.crumb li::after {
  content: 'â€º';
  margin: 0 .25rem 0 .5rem;
}

.crumb li:last-child::after {
  content: '';
}

.crumb a {
  color: #cfd8dc;
}

.crumb i {
  margin-right: .5em;
}

.share {
  padding: 0;
}

.share a {
  display: inline-block;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  min-width: 1rem;
  height: 2rem;
  border-radius: 4px;
  color: #333;
  font-size: .8rem;
  font-weight: 700;
  line-height: 2rem;
  text-align: center;
  padding: 0 .5rem;
}

.adj article.lism {
  margin-bottom: 1rem;
}

.adj header {
  font-weight: 700;
  font-size: .8rem;
}

.toc {
  padding: 0 2rem;
}

@media (max-width: 768px) {
  .toc {
    padding: 0 1rem;
  }
}

.toc {
  margin: 1rem 0;
}

.toc nav>ul {
  background-color: #eceff1;
  border-radius: 4px;
  display: inline-block;
  font-size: .8rem;
  padding: .5rem 1rem;
  word-break: break-all;
  list-style: none;
}

.toc ul {
  padding: 0;
}

.toc ul ul {
  padding-left: 1rem;
}

.toc ul ul ul {
  padding-left: 1rem;
}

.toc li {
  color: #90a4ae;
}

.toc ul ul>li {
  font-weight: 700;
  margin: .5rem 0;
  list-style-type: decimal;
}

.toc ul ul ul>li {
  list-style-type: disc;
  font-weight: 500;
}

.author {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  padding: 1rem;
  border-radius: 4px;
  text-align: center;
}

.author .author-thumb {
  margin: 0 auto 1rem;
  width: 6rem;
  height: 6rem;
  border-radius: 50%;
  background-color: #eceff1;
  background-size: cover;
  background-position: center;
}

.author .author-name {
  margin-bottom: .5rem;
  font-weight: 700;
}

.author .author-facts {
  margin-bottom: 1rem;
}

.author .author-facts li {
  display: inline;
}

.author .author-facts li a {
  display: inline-block;
  background-color: #eceff1;
  width: 1.75rem;
  height: 1.75rem;
  line-height: 1.75rem;
  text-align: center;
  color: #333;
  font-size: .8rem;
  border-radius: 2px;
}

.author .author-facts li a:hover {
  color: #fff;
  background-color: #333;
}

.author .author-description {
  text-align: left;
  font-size: .8rem;
}

.author .author-description p {
  margin: .5rem 0;
}

.thumb {
  background-image: url(https://lbarasti.com/images/default.jpg);
  background-size: cover;
  background-position: center;
}



.thumb-f53907a89c330f8b996d611ad301fd8a {
  background-image: url(https://lbarasti.com/src/ruby_ractor/00_header.png);
}



.thumb-8eaea0461a73c8e51c8ff91c77df7ab0 {
  background-image: url(https://lbarasti.com/src/json_beyond_basics/header.svg);
}



.thumb-379cdddbc8bab5ea691bccb3059844eb {
  background-image: url(https://lbarasti.com/src/byoidsl/00_header.png);
}



.thumb-b0e4f6f597dd7100c40a783ccbe3c9f9 {
  background-image: url(https://lbarasti.com/src/game_of_life/06_ex.png);
}



.thumb-b3e7b513b3545669e5ee97fd0b828bf4 {
  background-image: url(https://lbarasti.com/src/select_statement/00_header.png);
}



.thumb-224ddb75e51dd0d04b1e71827aad96f9 {
  background-image: url(https://lbarasti.com/src/intro_to_statistics/00_header.png);
}



.thumb-408d2f8615f913914e565d9a2093a3a4 {
  background-image: url(https://lbarasti.com/src/url_checker_series/header.jpeg);
}



.thumb-2f8501660be1b202f0622f4169e68f2a {
  background-image: url(https://lbarasti.com/src/two_way_communication/00_header_3.png);
}



.thumb-a79bcaa63d57a1252d925acc5f4a4d76 {
  background-image: url(https://lbarasti.com/images/crystal-symbol.png);
}




article.sn > .article-body figcaption {
  color: #1c9fda;
  font-size: .8rem;
  font-weight: 700;
  margin-top: .5rem;
}



    </style>

<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', "UA-97340845-1", 'auto', {'useAmpClientId': true});
ga('send', 'pageview');
</script>

  </head>
  <body>
    <header class="l-header">
      <div class="l-container">
        <div class="logo">
          <a href="https://lbarasti.com/">lbarasti&#39;s blog</a>
        </div>
        

      </div>
    </header>

    <main>
      <div class="l-container">
        
<div class="mrow">
  <div class="mcol c8">

    <article class="sn">

  <div class="thumb thumb-8eaea0461a73c8e51c8ff91c77df7ab0"></div>

  <header class="article-header">
    <h1 class="title">Crystal JSON beyond the basics</h1>

    <ul class="facts">
      <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="2020-09-21T00:17:01JST">Sep 21, 2020</time></li>
      
      <li><i class="fas fa-bookmark" aria-hidden="true"></i><a href="https://lbarasti.com/post/">POST</a></li>
      
    </ul>

    <aside class="share">
  <a href="https://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f&title=Crystal%20JSON%20beyond%20the%20basics" title="ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒžãƒ¼ã‚¯" class="ht" target="_blank" rel="nofollow">B!</a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f&text=Crystal%20JSON%20beyond%20the%20basics&tw_p=tweetbutton" title="Twitterã§ã‚·ã‚§ã‚¢" class="tw" target="_blank" rel="nofollow"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f&t=Crystal%20JSON%20beyond%20the%20basics" title="Facebookã§ã‚·ã‚§ã‚¢" class="fb" target="_blank" rel="nofollow"><i class="fab fa-facebook" aria-hidden="true"></i></a>
  <a href="https://getpocket.com/edit?url=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f&title=Crystal%20JSON%20beyond%20the%20basics" title="Pocketã«ä¿å­˜" class="pk" target="_blank" rel="nofollow"><i class="fab fa-get-pocket" aria-hidden="true"></i></a>
  <a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f" title="LINEã§ã‚·ã‚§ã‚¢" class="ln" target="_blank" rel="nofollow"><i class="fab fa-line" aria-hidden="true"></i></a>
</aside>

  </header>

  

  <div class="article-body"><h2 id="introduction">Introduction</h2>
<p>When modelling a business domain, you will often find yourself defining custom data types on the top of the language&rsquo;s primitives. If you&rsquo;ve been exposed to some functional programming, you&rsquo;re likely to strive for <a href="https://jrsinclair.com/articles/2019/algebraic-data-types-what-i-wish-someone-had-explained-about-functional-programming/">sum types</a>, in particular.</p>
<p>In Crystal, we can represent sum types as composite types inheriting from an abstract one. As a side benefit, this pattern makes it straightforward to encode (and decode) custom types into (and from) JSON, as hinted in the <a href="https://crystal-lang.org/api/0.35.1/JSON/Serializable.html">official documentation</a>.</p>
<p>In this article, we&rsquo;ll look at how we can JSON-encode and decode sum types in Crystal using the <code>json</code> module and its powerful macros.</p>
<p>We&rsquo;ll cover:</p>
<ul>
<li>Automatic encoding with <code>JSON::Serializable</code></li>
<li>Type resolution with discriminators</li>
<li>Encoding of nested composite data types</li>
<li>Considerations on the extensibility of this approach</li>
</ul>
<h2 id="case-study---a-p2p-client">Case study - a P2P client</h2>
<p>Suppose we want to model events related to a peer to peer application. We&rsquo;ll focus on two domain events:</p>
<ul>
<li><code>Connected</code> event: a connection with a peer is established</li>
<li><code>Started</code> event: a file piece download is started.</li>
</ul>
<p>A common pattern in this scenario is to represent the various types of event as classes or structs inheriting from a base <code>Event</code> type. Events are inherently immutable, so it makes sense to model them as structs with getters.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#66d9ef">alias</span> <span style="color:#a6e22e">Peer</span> <span style="color:#f92672">=</span> String

<span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Event</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Connected</span> <span style="color:#f92672">&lt;</span> Event
  getter peer
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(@peer : Peer); <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Started</span> <span style="color:#f92672">&lt;</span> Event
  getter peer, piece
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(@peer : Peer, @piece : UInt32); <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></td></tr></table>
</div>
</div>
<p>In the snippet above</p>
<ul>
<li>On line 1, a <code>Peer</code> is represented by a string - its IP address.</li>
<li>On line 3, we define an abstract struct <code>Event</code> which serves as base type for all the concrete event types. Mind that the <a href="https://crystal-lang.org/reference/syntax_and_semantics/virtual_and_abstract_types.html">abstract</a> identifier makes it so that <code>Event</code> objects cannot be instantiated - meaning <code>Event.new</code> won&rsquo;t compile.</li>
</ul>
<h4 id="json-encoding">JSON encoding</h4>
<p>As we are contemplating our nicely designed events hierarchy, a requirement comes in saying that we need to persist all the P2P events processed by our application for auditing purposes. After an intense discussion with the team, we decide to go for the JSON format. Let&rsquo;s update our code so that we can turn <code>Event</code> instances into JSON</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#66d9ef">require</span> <span style="color:#e6db74">&#34;json&#34;</span>

<span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Event</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">JSON</span><span style="color:#f92672">::</span>Serializable
<span style="color:#66d9ef">end</span></code></pre></td></tr></table>
</div>
</div>
<p>Here we are importing the JSON package (line 1), and then simply <em>mixing</em> the <code>JSON::Serializable</code> module <em>into</em> <code>Event</code> (line 4).</p>
<p>Is that it? Well, let&rsquo;s see&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal">e0 <span style="color:#f92672">=</span> Connected<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;0.0.0.0&#34;</span>) <span style="color:#75715e">#=&gt; Connected(@peer=&#34;0.0.0.0&#34;)</span>
e1 <span style="color:#f92672">=</span> Started<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, <span style="color:#ae81ff">2</span>) <span style="color:#75715e">#=&gt; Started(@peer=&#34;0.0.0.0&#34;, @piece=2)</span>

e0<span style="color:#f92672">.</span>to_json <span style="color:#75715e">#=&gt; {&#34;peer&#34;:&#34;0.0.0.0&#34;}</span>
e1<span style="color:#f92672">.</span>to_json <span style="color:#75715e">#=&gt; {&#34;peer&#34;:&#34;0.0.0.0&#34;,&#34;piece&#34;:2}</span>
</code></pre></div><p>Now, that&rsquo;s impressive! Simply including the <code>JSON::Serializable</code> module into the base type resulted in equipping its subtypes with working <code>#to_json</code> methods. The following works, too:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal">Connected<span style="color:#f92672">.</span>from_json(e0<span style="color:#f92672">.</span>to_json) <span style="color:#75715e">#=&gt; Connected(@peer=&#34;0.0.0.0&#34;)</span>
Started<span style="color:#f92672">.</span>from_json(e1<span style="color:#f92672">.</span>to_json) <span style="color:#75715e">#=&gt; Started(@peer=&#34;0.0.0.0&#34;, @piece=2)</span>
</code></pre></div><p>This is nice, e.g. for testing purposes, but mind that the exact type of an event will likely be unknown to us at compile time, so what we&rsquo;d <em>actually</em> like to run is</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal">Event<span style="color:#f92672">.</span>from_json(e0<span style="color:#f92672">.</span>to_json)
<span style="color:#75715e"># raises &#34;Error: can&#39;t instantiate abstract struct Event&#34;</span>
</code></pre></div><p>Unfortunately, this raises an error: by default, the deserializer defined within the <code>JSON::Serializable</code> module tries to instantiate an <code>Event</code> object. As we mentioned above, this is not possible, due to the abstract nature of the type. So, where do we go from here?</p>
<h4 id="discriminators-to-the-rescue">Discriminators to the rescue</h4>
<p>Here is an idea: in order to deserialize a JSON payload to the correct runtime type, we will attach some extra metadata about the event type to the JSON itself. We call this field a <em>discriminator</em>.</p>
<p>Luckily, the <code>json</code> module comes with an aptly named <code>use_json_discriminator</code> macro. This will give us the deserialization capability we are looking for, but it&rsquo;s up to us to make sure that the discriminator field is populated properly at serialization time.</p>
<p>Let&rsquo;s update our code to add support for discriminators.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Event</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">JSON</span><span style="color:#f92672">::</span>Serializable

  use_json_discriminator <span style="color:#e6db74">&#34;type&#34;</span>, {
    <span style="color:#e6db74">connected</span>: Connected,
    <span style="color:#e6db74">started</span>: Started
  }
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Connected</span> <span style="color:#f92672">&lt;</span> Event
  getter peer
  getter <span style="color:#66d9ef">type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;connected&#34;</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(@peer : Peer); <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Started</span> <span style="color:#f92672">&lt;</span> Event
  getter peer, piece
  getter <span style="color:#66d9ef">type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;started&#34;</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(@peer : Peer, @piece : UInt32); <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></td></tr></table>
</div>
</div>
<p>OK, what&rsquo;s going here?</p>
<ul>
<li>On line 4, we call <code>use_json_discriminator</code> by providing a mapping between a discriminator field value and a type. The deserializer expects the discriminator to appear under the <em>&ldquo;type&rdquo;</em> field, in this case.</li>
<li>lines 12 and 18 ensure that the <code>type</code> field is populated according to the event type name.</li>
</ul>
<p>You&rsquo;ll notice a correspondence between the value of each <code>type</code> field and the discriminator mapping.</p>
<p>Let&rsquo;s check how this affects our serializer.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal">e0<span style="color:#f92672">.</span>to_json <span style="color:#75715e">#=&gt; {&#34;type&#34;:&#34;connected&#34;,&#34;peer&#34;:&#34;0.0.0.0&#34;}</span>
e1<span style="color:#f92672">.</span>to_json <span style="color:#75715e">#=&gt; {&#34;type&#34;:&#34;started&#34;,&#34;peer&#34;:&#34;0.0.0.0&#34;,&#34;piece&#34;:2}</span>
</code></pre></div><p>Notice how the type metadata is now part of the generated JSON. This in turn makes the following work:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal">Event<span style="color:#f92672">.</span>from_json(e0<span style="color:#f92672">.</span>to_json) <span style="color:#75715e">#=&gt; Connected(@type=&#34;connected&#34;, @peer=&#34;0.0.0.0&#34;)</span>
Event<span style="color:#f92672">.</span>from_json(e1<span style="color:#f92672">.</span>to_json) <span style="color:#75715e">#=&gt; Started(@type=&#34;started&#34;, @peer=&#34;0.0.0.0&#34;, @piece=2)</span>
</code></pre></div><p>Brilliant!</p>
<h4 id="composing-composite-types">Composing composite types</h4>
<p>The above works all right with composite types where fields are primitive types, but what if we were to define composite types on the top of other composite types? ðŸ˜±</p>
<p>Let&rsquo;s expand the definition of <code>Peer</code> to check this out:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Peer</span>
  getter address : String
  getter port : Int32

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(@address, @port)
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

e0 <span style="color:#f92672">=</span> Connected<span style="color:#f92672">.</span>new(Peer<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, <span style="color:#ae81ff">8020</span>))
e1 <span style="color:#f92672">=</span> Started<span style="color:#f92672">.</span>new(Peer<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, <span style="color:#ae81ff">8020</span>), <span style="color:#ae81ff">2</span>)
</code></pre></div><p>Now the following fails</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal">e0<span style="color:#f92672">.</span>to_json
<span style="color:#75715e"># raises &#34;Error: no overload matches &#39;Peer#to_json&#39; with type JSON::Builder&#34;</span>
</code></pre></div><p>The compiler is pretty explicit here: it does not know how to turn a <code>Peer</code> object into JSON.</p>
<p>ðŸ¤” I know this one! Let&rsquo;s include <code>JSON::Serializable</code> into <code>Peer</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Peer</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">JSON</span><span style="color:#f92672">::</span>Serializable

  getter address : String
  getter port : Int32

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(@address, @port)
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>And now try</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal">e0<span style="color:#f92672">.</span>to_json <span style="color:#75715e">#=&gt; {&#34;type&#34;:&#34;connected&#34;,&#34;peer&#34;:{&#34;address&#34;:&#34;0.0.0.0&#34;,&#34;port&#34;:8020}}</span>
e1<span style="color:#f92672">.</span>to_json <span style="color:#75715e">#=&gt; {&#34;type&#34;:&#34;started&#34;,&#34;peer&#34;:{&#34;address&#34;:&#34;0.0.0.0&#34;,&#34;port&#34;:8020},&#34;piece&#34;:2}</span>
</code></pre></div><p>Success! What about deserialization?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal">Event<span style="color:#f92672">.</span>from_json(s0) <span style="color:#75715e">#=&gt; Connected(@type=&#34;connected&#34;, @peer=Peer(@address=&#34;0.0.0.0&#34;, @port=8020))</span>
Event<span style="color:#f92672">.</span>from_json(s1) <span style="color:#75715e">#=&gt; Started(@type=&#34;started&#34;, @peer=Peer(@address=&#34;0.0.0.0&#34;, @port=8020), @piece=2)</span>
</code></pre></div><p>Excellent! This is really all there is to it. Let&rsquo;s wrap up with an interesting trick and some more considerations on the extensibility of this method.</p>
<h4 id="adding-event-subtypes">Adding Event subtypes</h4>
<p>At present, both the base event type and its implementation are JSON-aware, meaning the code in both includes bits related to the JSON support.</p>
<p>This is not an issue in itself, but it feels like the JSON logic is leaking implementation details into the <code>Event</code> subtypes definition. Could we make it so that an <code>Event</code> implementer does not have to know about the <em>type</em> field? After all, the <code>type</code> getter returns a value that can be computed programmatically  - in this case, a downcase version of the type name.</p>
<p>It turns out we can:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Event</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">JSON</span><span style="color:#f92672">::</span>Serializable

  use_json_discriminator <span style="color:#e6db74">&#34;type&#34;</span>, {<span style="color:#e6db74">connected</span>: Connected, <span style="color:#e6db74">started</span>: Started}

  <span style="color:#66d9ef">macro</span> <span style="color:#a6e22e">inherited</span>
    getter <span style="color:#66d9ef">type</span> : String <span style="color:#f92672">=</span> <span style="color:#e6db74">{{</span>@type<span style="color:#f92672">.</span>stringify<span style="color:#f92672">.</span>downcase<span style="color:#e6db74">}}</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></td></tr></table>
</div>
</div>
<p>Wait, what is this <code>macro inherited</code> on line 6 about? It&rsquo;s a special macro <em>hook</em> that injects the code in its body into any type inheriting from <code>Event</code>. This is exactly what we need, as it gives us the opportunity to inject the <code>type</code> getter into each implementation of <code>Event</code> and set it to the type name, stringified and downcased. On line 7, note that occurrences of <code>@type</code> in a macro resolve to the name of the instantiating type.</p>
<p>Now the rest of the code looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Connected</span> <span style="color:#f92672">&lt;</span> Event
  getter peer
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(@peer : Peer); <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Started</span> <span style="color:#f92672">&lt;</span> Event
  getter peer, piece
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(@peer : Peer, @piece : UInt32); <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>No trace of JSON logic ðŸŽ‰</p>
<p>Let&rsquo;s introduce a new <code>Event</code> type to demonstrate this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#75715e"># An event indicating the completion of a file piece.</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Completed</span> <span style="color:#f92672">&lt;</span> Event
  getter peer, piece
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(@peer : Peer, @piece : UInt32); <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>No extra logic on the implementer side, as expected, but mind that we still need to update the discriminator mapping:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Event</span>
  use_json_discriminator <span style="color:#e6db74">&#34;type&#34;</span>, {
    <span style="color:#e6db74">connected</span>: Connected,
    <span style="color:#e6db74">started</span>: Started,
    <span style="color:#e6db74">completed</span>: Completed
  }
  <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p><strong>Challenge.</strong> Can we avoid having to manually update the mapping?</p>
<p><em>Hint:</em> the following macro generates exactly the <code>NamedTupleLiteral</code> we&rsquo;re looking for:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal"><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Event</span>
  <span style="color:#66d9ef">macro</span> <span style="color:#a6e22e">subclasses</span>
    {
      <span style="color:#e6db74">{%</span> <span style="color:#66d9ef">for</span> name <span style="color:#66d9ef">in</span> @type<span style="color:#f92672">.</span>subclasses <span style="color:#e6db74">%}</span>
      <span style="color:#e6db74">{{</span> name<span style="color:#f92672">.</span>stringify<span style="color:#f92672">.</span>downcase<span style="color:#f92672">.</span>id <span style="color:#e6db74">}}</span>: <span style="color:#e6db74">{{</span> name<span style="color:#f92672">.</span>id <span style="color:#e6db74">}}</span>,
      <span style="color:#e6db74">{%</span> <span style="color:#66d9ef">end</span> <span style="color:#e6db74">%}</span>
    }
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

Event<span style="color:#f92672">.</span>subclasses <span style="color:#75715e"># =&gt; {connected: Connected, started: Started, completed: Completed}</span>
</code></pre></div><p>Unfortunately, the following does not work.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-crystal" data-lang="crystal">use_json_discriminator <span style="color:#e6db74">&#34;type&#34;</span>, Event<span style="color:#f92672">.</span>subclasses
<span style="color:#75715e">#=&gt; raises Error: mapping argument must be a HashLiteral or a NamedTupleLiteral, not Call</span>
</code></pre></div><p>This is because at the time when the <code>use_json_discriminator</code> macro is expanded, <code>Event.subclasses</code> hasn&rsquo;t been expanded, yet. I&rsquo;ve seen this kind of issues arising often when working with macros: they can save you from writing a lot of code, but composing them can be frustratingly complicated.</p>
<p>Here is my recommendation:</p>
<blockquote>
<p>when working with macros, keep it simple. If something feels too complicated, it probably is.</p>
</blockquote>
<p>Anyhow, leave a comment in the section below, if you&rsquo;d like to share your <em><del>hack</del></em> solution.</p>
<h2 id="further-reading">Further reading</h2>
<ul>
<li>This article was inspired by my experience writing a <a href="https://github.com/lbarasti/torrent_client/blob/183d9d0d4e4ac95b61937d13b6d5f77d4b034a9e/src/lib/reporter.cr">BitTorrent client</a> in Crystal.</li>
<li>If you&rsquo;d like to find out more about Algebraic Data Types, I recommend <a href="https://jrsinclair.com/articles/2019/algebraic-data-types-what-i-wish-someone-had-explained-about-functional-programming/">this article</a> by James Sinclair.</li>
<li>You can find the official <code>json</code> module documentation <a href="https://crystal-lang.org/api/0.35.1/JSON.html">here</a></li>
<li>To read more about Crystal&rsquo;s macro hooks, check out the official Crystal <a href="https://crystal-lang.org/reference/syntax_and_semantics/macros/hooks.html">reference</a></li>
</ul>
<h2 id="heading"></h2>
<p>I hope you enjoyed this JSON-themed article and learned something new about Crystal. If you have any question or learning in the JSON-serialization space, then I&rsquo;d love to read about it in the comments section below.</p>
<p>If you&rsquo;d like to stay in touch, you can subscribe or follow me on <a href="https://twitter.com/lbarasti">Twitter</a>. You can also find me live coding on <a href="https://www.twitch.tv/lbarasti">Twitch</a>, sometimes ðŸ“º</p>

<link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
	#mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
	 
</style>
<div id="mc_embed_signup">
<form action="https://lbarasti.us4.list-manage.com/subscribe/post?u=2ae02926c5ced578d57958587&amp;id=e952a286b4" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL"></label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_2ae02926c5ced578d57958587_e952a286b4" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>


</div>

  <footer class="article-footer">

    <aside class="share">
  <a href="https://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f&title=Crystal%20JSON%20beyond%20the%20basics" title="ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒžãƒ¼ã‚¯" class="ht" target="_blank" rel="nofollow">B!</a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f&text=Crystal%20JSON%20beyond%20the%20basics&tw_p=tweetbutton" title="Twitterã§ã‚·ã‚§ã‚¢" class="tw" target="_blank" rel="nofollow"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f&t=Crystal%20JSON%20beyond%20the%20basics" title="Facebookã§ã‚·ã‚§ã‚¢" class="fb" target="_blank" rel="nofollow"><i class="fab fa-facebook" aria-hidden="true"></i></a>
  <a href="https://getpocket.com/edit?url=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f&title=Crystal%20JSON%20beyond%20the%20basics" title="Pocketã«ä¿å­˜" class="pk" target="_blank" rel="nofollow"><i class="fab fa-get-pocket" aria-hidden="true"></i></a>
  <a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2flbarasti.com%2fpost%2fjson_beyond_basics%2f" title="LINEã§ã‚·ã‚§ã‚¢" class="ln" target="_blank" rel="nofollow"><i class="fab fa-line" aria-hidden="true"></i></a>
</aside>


    <section class="footer">
      <div>
        <nav class="crumb">
          <ol>
            <li><a href="https://lbarasti.com/"><i class="fas fa-home" aria-hidden="true"></i>TOP</a></li>
            
            <li itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="https://lbarasti.com/post/" itemprop="url"><span itemprop="title">POST</span></a></li>
            
            <li class="active">Crystal JSON beyond the basics</li>
          </ol>
        </nav>
      </div>
    </section>

    
    
    
    <section class="footer">
      <header>
        <a href="https://lbarasti.com/categories/">CATEGORIES</a>
      </header>
      <div>
        <ul class="terms">
          
        </ul>
      </div>
    </section>
    
    
    
    <section class="footer">
      <header>
        <a href="https://lbarasti.com/tags/">TAGS</a>
      </header>
      <div>
        <ul class="terms">
          
          <li><a href="https://lbarasti.com/tags/crystal/">crystal</a></li>
          
          <li><a href="https://lbarasti.com/tags/json/">json</a></li>
          
          <li><a href="https://lbarasti.com/tags/adt/">ADT</a></li>
          
          <li><a href="https://lbarasti.com/tags/serialization/">serialization</a></li>
          
          <li><a href="https://lbarasti.com/tags/macros/">macros</a></li>
          
        </ul>
      </div>
    </section>
    
    
  </footer>

</article>


    <div class="adj">
      <div class="mrow">
        
        <div class="mcol c6">
          <header>Previous Article</header>
          <article class="lism">
  <a href="https://lbarasti.com/post/byoidsl/">
    <div class="thumb thumb-379cdddbc8bab5ea691bccb3059844eb"></div>

    <div class="inner">
      <div class="title">Building an interactive DSL</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="7007-07-07T19:17:57JST">Jul 7, 2020</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

        </div>
        
        
        <div class="mcol c6">
          <header>Next Article</header>
          <article class="lism">
  <a href="https://lbarasti.com/post/ruby_ractor/">
    <div class="thumb thumb-f53907a89c330f8b996d611ad301fd8a"></div>

    <div class="inner">
      <div class="title">Ruby Ractor</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="25007-01-25T20:12:48JST">Jan 25, 2021</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

        </div>
        
      </div>
    </div>

    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lbarasti-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
  <div class="mcol c4">
    <aside class="l-sidebar">

  <div class="sections sidebar">
    
<section class="sidebar">
  <header>AUTHOR</header>
  <div>
    <div class="author">
      
      <div class="author-thumb" style="background-image: url(https://lbarasti.com/images/profile-picture.jpg);"></div>
      
      <div class="author-name">Lorenzo Barasti</div>
      <ul class="author-facts">
        
        <li><a href="https://twitter.com/lbarasti" rel="nofollow" target="_blank"><i class="fab fa-twitter" aria-hidden="true"></i></a></li>
        <li><a href="https://github.com/lbarasti" rel="nofollow" target="_blank"><i class="fab fa-github" aria-hidden="true"></i></a></li>
        <li><a href="https://www.youtube.com/channel/UCaydNuV-VSO0gFSrvS9WgXg" rel="nofollow" target="_blank"><i class="fab fa-youtube" aria-hidden="true"></i></a></li>
        <li><a href="https://twitch.tv/lbarasti" rel="nofollow" target="_blank"><i class="fab fa-twitch" aria-hidden="true"></i></a></li>
      </ul>
      <div class="author-description">Exploring concurrency in Crystal, live coding on occasion.</div>
    </div>
  </div>
</section>


    <section class="sidebar">
  <header>LATESTS</header>
  <div>
    <div class="articles sm">
      
      <article class="lism">
  <a href="https://lbarasti.com/post/ruby_ractor/">
    <div class="thumb thumb-f53907a89c330f8b996d611ad301fd8a"></div>

    <div class="inner">
      <div class="title">Ruby Ractor</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="25007-01-25T20:12:48JST">Jan 25, 2021</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
      <article class="lism">
  <a href="https://lbarasti.com/post/json_beyond_basics/">
    <div class="thumb thumb-8eaea0461a73c8e51c8ff91c77df7ab0"></div>

    <div class="inner">
      <div class="title">Crystal JSON beyond the basics</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="21007-09-21T00:17:01JST">Sep 21, 2020</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
      <article class="lism">
  <a href="https://lbarasti.com/post/byoidsl/">
    <div class="thumb thumb-379cdddbc8bab5ea691bccb3059844eb"></div>

    <div class="inner">
      <div class="title">Building an interactive DSL</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="7007-07-07T19:17:57JST">Jul 7, 2020</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
      <article class="lism">
  <a href="https://lbarasti.com/post/game_of_life/">
    <div class="thumb thumb-b0e4f6f597dd7100c40a783ccbe3c9f9"></div>

    <div class="inner">
      <div class="title">Conway&#39;s Game of Life, sparse</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="20007-06-20T18:52:41JST">Jun 20, 2020</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
      <article class="lism">
  <a href="https://lbarasti.com/post/select_statement/">
    <div class="thumb thumb-b3e7b513b3545669e5ee97fd0b828bf4"></div>

    <div class="inner">
      <div class="title">5 use cases for Crystal&#39;s select statement</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="30007-04-30T23:03:29JST">Apr 30, 2020</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
      <article class="lism">
  <a href="https://lbarasti.com/post/intro_to_statistics/">
    <div class="thumb thumb-224ddb75e51dd0d04b1e71827aad96f9"></div>

    <div class="inner">
      <div class="title">Sampling random variables and plotting histograms in Crystal</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="10007-04-10T10:12:33JST">Apr 10, 2020</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
      <article class="lism">
  <a href="https://lbarasti.com/post/url_checker_series/">
    <div class="thumb thumb-408d2f8615f913914e565d9a2093a3a4"></div>

    <div class="inner">
      <div class="title">Live coding a URL checker in Crystal</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="12007-01-12T22:12:33JST">Jan 12, 2020</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
      <article class="lism">
  <a href="https://lbarasti.com/post/two_way_comm_between_fibers/">
    <div class="thumb thumb-2f8501660be1b202f0622f4169e68f2a"></div>

    <div class="inner">
      <div class="title">2-way communication between Fibers</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="25007-11-25T22:12:33JST">Nov 25, 2019</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
      <article class="lism">
  <a href="https://lbarasti.com/post/fun_with_crystal/">
    <div class="thumb thumb-a79bcaa63d57a1252d925acc5f4a4d76"></div>

    <div class="inner">
      <div class="title">Going faster with Crystal</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="12007-04-12T10:12:33JST">Apr 12, 2017</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
    </div>
  </div>
</section>

    

    
<section class="sidebar">
  <header>TAGS</header>
  <div>
    <ul class="terms">
      <li><a href="https://lbarasti.com/tags/crystal">crystal <span class="count">(8)</span></a></li><li><a href="https://lbarasti.com/tags/concurrency">concurrency <span class="count">(4)</span></a></li><li><a href="https://lbarasti.com/tags/channel">channel <span class="count">(3)</span></a></li><li><a href="https://lbarasti.com/tags/fiber">fiber <span class="count">(3)</span></a></li><li><a href="https://lbarasti.com/tags/game-of-life">game-of-life <span class="count">(2)</span></a></li><li><a href="https://lbarasti.com/tags/macros">macros <span class="count">(2)</span></a></li><li><a href="https://lbarasti.com/tags/ruby">ruby <span class="count">(2)</span></a></li><li><a href="https://lbarasti.com/tags/actor">actor <span class="count">(1)</span></a></li><li><a href="https://lbarasti.com/tags/actors">actors <span class="count">(1)</span></a></li><li><a href="https://lbarasti.com/tags/adt">adt <span class="count">(1)</span></a></li>
    </ul>
  </div>
</section>



  </div>

</aside>

  </div>
</div>

      </div>
    </main>

    <footer class="l-footer">
      <div class="l-container">
        <p><span class="h-logo">&copy; lbarasti&#39;s blog</span></p>
        <aside>
          <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
          <p><a href="https://github.com/dim0627/hugo_theme_robust">Robust</a> designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>.</p>
        </aside>
      </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>


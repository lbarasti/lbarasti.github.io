<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="theme-color" content="#263238">

<meta name="generator" content="Hugo 0.61.0" />

<link rel="apple-touch-icon" href="https://lbarasti.comimages/logo.png">




    <link rel="canonical" href="https://lbarasti.com/post/fun_with_crystal/">
    
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,700" rel="stylesheet">
    
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <title>Going faster with Crystal - lbarasti&#39;s blog</title>
    
<meta name="description" content="When it comes to scripting, can we write code in a modern language, without having to worry about performance overhead?">

<meta property="og:title" content="Going faster with Crystal - lbarasti&#39;s blog">
<meta property="og:type" content="article">
<meta property="og:url" content="https://lbarasti.com/post/fun_with_crystal/">
<meta property="og:image" content="https://lbarasti.com/images/crystal-symbol.png">
<meta property="og:site_name" content="lbarasti&#39;s blog">
<meta property="og:description" content="When it comes to scripting, can we write code in a modern language, without having to worry about performance overhead?">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="lbarasti&#39;s blog">
<meta name="twitter:url" content="https://lbarasti.com/post/fun_with_crystal/">
<meta name="twitter:title" content="Going faster with Crystal - lbarasti&#39;s blog">
<meta name="twitter:description" content="When it comes to scripting, can we write code in a modern language, without having to worry about performance overhead?">
<meta name="twitter:image" content="https://lbarasti.com/images/crystal-symbol.png">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"https:\/\/lbarasti.com"
    },
    "headline": "Going faster with Crystal-lbarasti's blog",
    "image": {
      "@type": "ImageObject",
      "url": "https:\/\/lbarasti.com\/images\/crystal-symbol.png",
      "height": 800,
      "width": 800
    },
    "datePublished": "2017-04-12T10:12:33JST",
    "dateModified": "2017-04-12T10:12:33JST",
    "author": {
      "@type": "Person",
      "name": "lbarasti's blog"
    },
    "publisher": {
      "@type": "Organization",
      "name": "lbarasti's blog",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/lbarasti.comimages/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "When it comes to scripting, can we write code in a modern language, without having to worry about performance overhead?"
  }
</script>


    <style>
html {
  font-size: 18px;
  background-color: rgba(236,239,241,.5);
}

@media (max-width: 768px) {
  html {
    font-size: 15px;
  }
}

body {
  color: #333;
  font-family: 'Roboto Slab','ヒラギノ角ゴ Pro W3','Hiragino Kaku Gothic Pro',メイリオ,Meiryo,sans-serif;
  font-feature-settings : "palt";
  font-size: inherit;
  line-height: 1rem;
  margin: 0;
  padding: 0;
}

h1, h2, h3, h4, h5 ,h6 {
  font-size: 1rem;
  font-weight: 700;
  line-height: 1rem;
  margin: 0;
}

hr {
  border: 0;
  border-top: 1px dashed #cfd8dc;
  margin: 1rem 0;
}

p {
  margin: 0;
  line-height: 1rem;
}

a {
  color: #2196f3;
  text-decoration: none;
  transition-duration: .3s;
}

ul, ol {
  margin: 0;
  padding: 0;
}

table {
  border-collapse: collapse;
}

th, td {
  font-size: .8rem;
  padding: .5rem;
}

tr {
  border-bottom: 1px dashed #ddd;
}

/* Layouts */
main,
aside {
  display: block;
}

main { padding: 1rem 0 3rem 0; }
aside.h { padding: 3rem 0; }

main.f,
aside.f {
  background-color: #333;
  border-top: 2px dashed #fff;
  border-bottom: 2px dashed #fff;
}

.l-container {
  position: relative;
  max-width: 68rem;
  margin: 0 auto;
  padding: 0 1rem;
}

.l-container.thin {
  max-width: 44rem;
}

.l-header {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  padding: 1rem 0;
  text-align: center;
}

.l-header .description {
  margin-top: .5rem;
  font-size: .8rem;
}

.l-footer {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  font-size: .6rem;
  font-weight: 700;
  padding: 1rem 0;
}

@media (max-width: 768px) {
  .l-sidebar {
    margin-top: 4rem;
  }
}

.mrow {
  margin: 0 -1rem;
  overflow: hidden;
}

.mcol {
  box-sizing: border-box;
  float: left;
  padding: 0 1rem;
}

.c6 { width: 50%; }
.c4 { width: 33.26323833%; }
.c8 { width: 66.66666%; }

@media (max-width: 768px) {
  .mcol {
    width: 100%;
    float: none;
  }
}

.logo a {
  font-size: 1.4rem;
  line-height: 1.5rem;
  font-weight: 700;
  color: #333;
}

.articles {
  margin: -1rem 0;
  margin-bottom: 1rem;
}

.articles.sm {
  margin: -.5rem 0;
  margin-bottom: 0;
}

article {
  border-radius: 4px;
  overflow: hidden;
}

article.li {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  height: 20rem;
  overflow: hidden;
  margin: 1rem 0;
}

article.li > a {
  display: block;
  color: #333;
}

article.li .inner {
  padding: 1rem;
}

article.li .thumb {
  height: 8rem;
}

article.li .title {
  color: #333;
  font-size: 1.2rem;
  line-height: 1.5rem;
  margin-bottom: .5rem;
}

article.li .summary {
  font-size: .8rem;
  height: 6rem;
  overflow: hidden;
  margin-top: 1rem;
}

article.li .summary::after {
  content: '...';
}

article.lism {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  margin: .5rem 0;
}

article.lism::after {
  content: '';
  display: block;
  clear: both;
}

article.lism > a {
  display: block;
  color: #333;
}

article.lism .inner {
  display: table-cell;
  vertical-align: middle;
  height: 5rem;
  padding: 0 .75rem;
}

article.lism .thumb {
  width: 5rem;
  height: 5rem;
  float: left;
}

article.lism .title {
  font-weight: 700;
  font-size: .8rem;
  margin-bottom: .25rem;
}

article.sn {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  margin-bottom: 1rem;
}

article.sn .thumb {
  height: 20rem;
}

@media (max-width: 768px) {
  article.sn .thumb {
    height: 10rem;
  }
}

article.sn > .article-header,
article.sn > .article-body,
article.sn .article-footer {
  padding: 2rem;
}

article.sn > .article-body {
  padding: 0 2rem;
}

@media (max-width: 768px) {
  article.sn > .article-header,
  article.sn > .article-body,
  article.sn .article-footer {
    padding: 1rem;
  }

  article.sn > .article-body {
    padding: 0 1rem;
  }
}

article.sn > .article-header .title {
  font-size: 1.8rem;
  line-height: 2rem;
  margin-bottom: .5rem;
}

@media (max-width: 768px) {
  article.sn > .article-header .title {
    font-size: 1.4rem;
    line-height: 1.5rem;
  }
}

article.sn > .article-header .facts {
  margin-bottom: 1rem;
}

article.sn > .article-body {
  margin-bottom: 1.5rem;
}

article.sn > .article-body h2 {
  border-bottom: .25rem solid #333;
  font-size: 1.2rem;
  line-height: 1.5rem;
  margin: 1.5rem 0;
  padding: .5rem 0;
}

article.sn > .article-body h3 {
  border-left: .5rem solid #333;
  line-height: 1.5rem;
  margin: 1.5rem 0;
  padding: .125rem .5rem;
}

article.sn > .article-body ul,
article.sn > .article-body ol {
  margin: 1.5rem 0;
  padding-left: 1.5rem;
}

article.sn > .article-body li {
  padding-bottom: .5rem;
  line-height: 1.5rem;
}

article.sn > .article-body li:last-child {
  padding-bottom: 0;
}
article.sn > .article-body p {
  margin: 1rem 0;
  line-height: 1.5rem;
}

article.sn > .article-body strong,
article.sn > .article-body em {
  font-style: normal;
  font-weight: 700;
}

article.sn > .article-body strong {
  box-shadow: 0 -.5rem 0 0 #ffc107 inset;
}

article.sn > .article-body em {
  color: #8bc34a;
}

article.sn > .article-body code,
article.sn > .article-body pre {
  font-family: Menlo, Consolas, monospace;
  font-size: .7rem;
}

article.sn > .article-body pre {
  background-color: #333;
  color: #fff;
  line-height: 1rem;
  margin: 1.5rem -2rem;
  overflow: auto;
}

@media (max-width: 768px) {
  article.sn > .article-body pre {
    margin: 1.5rem -1rem;
  }
}

article.sn > .article-body pre > code {
  display: block;
  padding: 1rem 2rem;
}

@media (max-width: 768px) {
  article.sn > .article-body pre > code {
    padding: 1rem;
  }
}

article.sn > .article-body p code {
  background-color: #eceff1;
  color: #333;
  border-radius: 4px;
  margin: 0 .25rem;
  padding: .375rem;
  white-space: nowrap;
}

article.sn > .article-body blockquote {
  position: relative;
  border-left: .25rem solid #333;
  font-size: .8rem;
  padding: .125rem 1rem;
  margin: 1.5rem 0;
}

@media (max-width: 768px) {
  article.sn > .article-body blockquote {
    font-size: 1rem;
  }
}

article.sn > .article-body blockquote p {
  margin: .5rem 0;
  line-height: 1rem;
}

article.sn > .article-body figure {
  margin: 1.5rem 0;
}

article.sn > .article-body img,
article.sn > .article-body figure img,
article.sn > .article-body figure amp-img {
  box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
  max-width: 100%;
}

article.sn > .article-body figcaption {
  color: #cfd8dc;
  font-size: .8rem;
  font-weight: 700;
  margin-top: .5rem;
}

.facts li {
  display: inline;
  font-size: .8rem;
  margin-right: 1rem;
}

.facts i {
  color: #cfd8dc;
  margin-right: .5em;
}

.facts.sm li {
  font-size: .7rem;
}

.sections.sidebar {
  margin: -1rem 0;
}

.sections.footer {
  margin: -1rem 0;
}

section.sidebar {
  margin: 2rem 0;
}

section.sidebar > header {
  font-size: .8rem;
  font-weight: 700;
  letter-spacing: 4px;
  text-align: center;
  margin: 1.5rem 0;
}

section.footer {
  margin: 1rem 0;
}

section.footer > header {
  font-size: .8rem;
  margin: .5rem 0;
}

section.footer > header::before {
  content: "- ";
}

section.footer > header a {
  font-weight: 700;
  color: #333;
  text-decoration: underline;
}

.terms {
  margin: -.25rem;
}

.terms li {
  display: inline-block;
}

.terms a {
  display: block;
  float: left;
  background-color: #333;
  border-radius: 4px;
  color: #fff;
  font-size: .7rem;
  margin: .25rem;
  padding: 0 .75rem;
  line-height: 1.75rem;
}

.paging {
  text-align: center;
  padding: 1rem 0;
}

.paging a {
  display: inline-block;
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  border-radius: 4px;
  color: #333;
  padding: 0 1rem;
  line-height: 3rem;
}

.page-title {
  text-align: center;
  margin: 1rem 0;
}

.page-title::after {
  content: '';
  display: block;
  border-bottom: .25rem solid #333;
  width: 3rem;
  margin: 1.5rem auto;
}

.page-title > .title {
  font-size: 1.2rem;
  line-height: 1.5rem;
}

/* Parts:breadcrumb */
.crumb ol {
  text-overflow: ellipsis;
  color: #cfd8dc;
  white-space: nowrap;
  overflow: hidden;
}

.crumb li {
  display: inline;
  font-size: .8rem;
}

.crumb li::after {
  content: '›';
  margin: 0 .25rem 0 .5rem;
}

.crumb li:last-child::after {
  content: '';
}

.crumb a {
  color: #cfd8dc;
}

.crumb i {
  margin-right: .5em;
}

.share {
  padding: 0;
}

.share a {
  display: inline-block;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  min-width: 1rem;
  height: 2rem;
  border-radius: 4px;
  color: #333;
  font-size: .8rem;
  font-weight: 700;
  line-height: 2rem;
  text-align: center;
  padding: 0 .5rem;
}

.adj article.lism {
  margin-bottom: 1rem;
}

.adj header {
  font-weight: 700;
  font-size: .8rem;
}

.toc {
  padding: 0 2rem;
}

@media (max-width: 768px) {
  .toc {
    padding: 0 1rem;
  }
}

.toc {
  margin: 1rem 0;
}

.toc nav>ul {
  background-color: #eceff1;
  border-radius: 4px;
  display: inline-block;
  font-size: .8rem;
  padding: .5rem 1rem;
  word-break: break-all;
  list-style: none;
}

.toc ul {
  padding: 0;
}

.toc ul ul {
  padding-left: 1rem;
}

.toc ul ul ul {
  padding-left: 1rem;
}

.toc li {
  color: #90a4ae;
}

.toc ul ul>li {
  font-weight: 700;
  margin: .5rem 0;
  list-style-type: decimal;
}

.toc ul ul ul>li {
  list-style-type: disc;
  font-weight: 500;
}

.author {
  background-color: #fff;
  box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05);
  padding: 1rem;
  border-radius: 4px;
  text-align: center;
}

.author .author-thumb {
  margin: 0 auto 1rem;
  width: 6rem;
  height: 6rem;
  border-radius: 50%;
  background-color: #eceff1;
  background-size: cover;
  background-position: center;
}

.author .author-name {
  margin-bottom: .5rem;
  font-weight: 700;
}

.author .author-facts {
  margin-bottom: 1rem;
}

.author .author-facts li {
  display: inline;
}

.author .author-facts li a {
  display: inline-block;
  background-color: #eceff1;
  width: 1.75rem;
  height: 1.75rem;
  line-height: 1.75rem;
  text-align: center;
  color: #333;
  font-size: .8rem;
  border-radius: 2px;
}

.author .author-facts li a:hover {
  color: #fff;
  background-color: #333;
}

.author .author-description {
  text-align: left;
  font-size: .8rem;
}

.author .author-description p {
  margin: .5rem 0;
}

.thumb {
  background-image: url(https://lbarasti.comimages/default.jpg);
  background-size: cover;
  background-position: center;
}



.thumb-2f8501660be1b202f0622f4169e68f2a {
  background-image: url(https://lbarasti.com/src/two_way_communication/00_header_3.png);
}



.thumb-a79bcaa63d57a1252d925acc5f4a4d76 {
  background-image: url(https://lbarasti.com/images/crystal-symbol.png);
}







    </style>

<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', "UA-97340845-1", 'auto', {'useAmpClientId': true});
ga('send', 'pageview');
</script>

  </head>
  <body>
    <header class="l-header">
      <div class="l-container">
        <div class="logo">
          <a href="https://lbarasti.com">lbarasti&#39;s blog</a>
        </div>
        

      </div>
    </header>

    <main>
      <div class="l-container">
        
<div class="mrow">
  <div class="mcol c8">

    <article class="sn">

  <div class="thumb thumb-a79bcaa63d57a1252d925acc5f4a4d76"></div>

  <header class="article-header">
    <h1 class="title">Going faster with Crystal</h1>

    <ul class="facts">
      <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="2017-04-12T10:12:33JST">Apr 12, 2017</time></li>
      
      <li><i class="fas fa-bookmark" aria-hidden="true"></i><a href="https://lbarasti.compost/">POST</a></li>
      
    </ul>

    <aside class="share">
  <a href="https://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f&title=Going%20faster%20with%20Crystal" title="はてなブックマーク" class="ht" target="_blank" rel="nofollow">B!</a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f&text=Going%20faster%20with%20Crystal&tw_p=tweetbutton" title="Twitterでシェア" class="tw" target="_blank" rel="nofollow"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f&t=Going%20faster%20with%20Crystal" title="Facebookでシェア" class="fb" target="_blank" rel="nofollow"><i class="fab fa-facebook" aria-hidden="true"></i></a>
  <a href="https://getpocket.com/edit?url=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f&title=Going%20faster%20with%20Crystal" title="Pocketに保存" class="pk" target="_blank" rel="nofollow"><i class="fab fa-get-pocket" aria-hidden="true"></i></a>
  <a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f" title="LINEでシェア" class="ln" target="_blank" rel="nofollow"><i class="fab fa-line" aria-hidden="true"></i></a>
</aside>

  </header>

  

  <div class="article-body"><p>Recently, I have been having some fun with the algorithmic challenges from one of the Algorithms courses on <a href="https://www.coursera.org/learn/algorithms-greedy">Coursera</a>. The programming language I like to use for this kind of things is ruby.</p>
<p>When designing an algorithm it's important for me to understand why <em>brute force</em> doesn't work. I like to <em>count</em> the reasons why that approach is not feasible. One way of doing that is to write a naïve implementation of the algorithm under study and make considerations about its running time. Let me give you an example.</p>
<h2 id="a-sample-problem">A sample problem</h2>
<p>We are given a set of 2D points with integer coordinates.
We define the distance between two points u,v as the <a href="https://xlinux.nist.gov/dads/HTML/manhattanDistance.html">Manhattan distance</a></p>
<blockquote>
<p>dist(u,v) = |x_u - x_v| + |y_u - y_v|</p>
</blockquote>
<p>where |n| is the absolute value of n.</p>
<p><figure>
    <img src="/src/fun_with_crystal/point_dist.png"
         alt="We work out the distance between two pairs of points. dist(A,B) = 2, dist(D,E) = 3"/> <figcaption>
            <p>Figure 1. We give a visual representation of the distance between two points as defined above and work out the computation for points A(1,1), B(3,1) and D(3,4), E(5,5)</p>
        </figcaption>
</figure>

<!-- raw HTML omitted --></p>
<p>Our task is to group the given points so that the minimum distance between any two groups - let's call them <em>clusters</em> - is at least 3.
In other words, if two points have distance less than 3, then we want them to be in the same cluster.</p>
<p><figure>
    <img src="/src/fun_with_crystal/cluster_dist.png"
         alt="We compute the distance between two clusters as the minimum distance between two points belonging to different clusters"/> <figcaption>
            <p>Figure 2. The figure shows a grouping of the points into clusters such that the distance between each cluster is at least 3. We define the distance between two clusters S_i, S_j as the minimum distance between u and v where u ∊ S_i and v ∊ S_j.</p>
        </figcaption>
</figure>

<!-- raw HTML omitted -->
The first approach that comes to my mind is the following: we compute the distance between all the possible pairs of points, and put points that are close enough in the same cluster.
The following pseudo-code seems to do the job.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">1</span><span style="color:#f92672"></span><span style="color:#f92672">..</span>n
  <span style="color:#66d9ef">for</span> j <span style="color:#66d9ef">in</span> i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672"></span><span style="color:#f92672">..</span>n
    <span style="color:#66d9ef">if</span> dist(i,j) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>
      <span style="color:#f92672"></span>merge_clusters(i, j)
</code></pre></div><p>Now, it's not clear how exactly we are going to keep track of which cluster a point is in at any given time, but even assuming we can do that efficiently with respect to the size of the problem - i.e. the number of points - we have a more urgent issue to deal with.</p>
<h2 id="the-more-urgent-issue">The more urgent issue</h2>
<p>The total number of pairs in a set of <code>n</code> points happens to be <code>n(n-1)/2</code>, which means that the number of pairs we need to go through grows quadratically with respect to the number of points. This implies that the computational cost of our brute force implementation is <em>at least</em> O(n²). Let's get a feel for that.</p>
<p>Try running the following ruby script for increasing values of <code>size</code> up to 10^5 - name the file <code>loop.rb</code> for future reference.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">size <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>your value here<span style="color:#f92672">&gt;</span>
a <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672"></span><span style="color:#f92672">..</span>size)<span style="color:#f92672">.</span>map{ <span style="color:#f92672">[</span>rand(<span style="color:#ae81ff">1000</span><span style="color:#f92672"></span>), rand(<span style="color:#ae81ff">1000</span><span style="color:#f92672"></span>)<span style="color:#f92672">]</span> }

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">dist</span>(u,v)
  (u<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672"></span><span style="color:#f92672">]</span> <span style="color:#f92672">-</span> v<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672"></span><span style="color:#f92672">]</span>)<span style="color:#f92672">.</span>abs <span style="color:#f92672">+</span> (u<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span><span style="color:#f92672"></span><span style="color:#f92672">]</span> <span style="color:#f92672">-</span> v<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span><span style="color:#f92672"></span><span style="color:#f92672">]</span>)<span style="color:#f92672">.</span>abs
<span style="color:#66d9ef">end</span>

a<span style="color:#f92672">.</span>each_with_index {<span style="color:#f92672">|</span>u,i<span style="color:#f92672">|</span>
  print <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">#{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672"></span><span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
  <span style="color:#f92672"></span>a<span style="color:#f92672">[</span>i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672"></span><span style="color:#f92672">..</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672"></span><span style="color:#f92672">]</span><span style="color:#f92672">.</span>each_with_index {<span style="color:#f92672">|</span>v,j<span style="color:#f92672">|</span>
    dist(u,v) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>
  <span style="color:#f92672"></span>}
}
</code></pre></div><p>On my machine the running time factor between <code>size = 10^4</code> and <code>size = 10^5</code> is about <!-- raw HTML omitted -->100<!-- raw HTML omitted -->. In particular, going through the nested for-loop with 100000 elements takes over 20 minutes. And we are not even computing the clusters yet!</p>
<p>So I'm thinking, maybe there's a better way of dealing with this, maybe we don't need to go through the array twice. On the other hand, maybe an interpreted language like ruby is just not the right tool for the job.</p>
<p>If only we could test this assumption without too much effort&hellip;</p>
<h2 id="meet-crystal">Meet Crystal!</h2>
<p>A friend recently told me about the Crystal language. He was so excited about it that I thought &ldquo;I should really check that out&rdquo;. Let me tell you why this looks like a good moment to do that.</p>
<p>Crystal is a compiled language designed to achieve <strong>high performance</strong> with <strong>low memory footprint</strong>. (One of) The killer feature(s) is the syntax. Crystal <strong>syntax</strong> is so similar to ruby that you might be able to convert your favourite ruby scripts with very little effort - especially if they are self-contained.</p>
<p>Now, that sounds a lot like what we want here: we have a self-contained ruby script, and we want it to run faster!</p>
<p>So after installing Crystal, I tried
<code>crystal loop.rb</code> - yes, just like that.</p>
<p>Our script happens to be fully compatible with Crystal's specification, so the <code>crystal</code> binary is happy to compile it and run it at once. Sadly, the runtime for size = 100000 is still over 12 minutes&hellip;</p>
<p>Is that it? Not really, the <a href="https://crystal-lang.org/docs/using_the_compiler/">getting started</a> guide to Crystal recommends you compile your source code with the <code>--release</code> flag once you're happy with it.</p>
<pre><code>crystal build loop.rb --release
</code></pre><p>This produces a blazing fast <code>loop</code> executable that runs in under 70 seconds. We just cut the running time by a factor of <!-- raw HTML omitted -->20<!-- raw HTML omitted --> and all we had to do was to compile and run our code with Crystal. Awesome!</p>
<h2 id="considerations">Considerations</h2>
<p>I hope you got to appreciate how Crystal can enhance the performance of our code without affecting our productivity.</p>
<p>And we've only scratched the surface! The language has way more to offer. Among other things, Crystal comes with a smart, non-obtrusive type system that prevents a wide range of little bugs from appearing in our code.</p>
<p>So next time you're faced with a computational challenge, why don't you give Crystal a try!</p>
<h2 id="but-were-not-done-yet">But we're not done yet</h2>
<p>If you're still reading, then you probably noticed I cheated a bit. I gave the outline of a sub-optimal brute force solution, and didn't even bother providing the full implementation of the clustering algorithm. I leave that to you for now, but I hope I'll be able to follow up on that soon.</p>
<p>And in case you're wondering &ldquo;Can we do any better than the brute force implementation?&rdquo; the answer is yes, we can indeed! In fact, we should be able to squeeze the running time to O(n) times the cost of merging two clusters.</p>
<h2 id="benchmark">Benchmark</h2>
<p>For the record, here is a table summarizing the running time of three different implementations.</p>
<table>
<thead>
<tr>
<th>Language</th>
<th>Running time</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ruby</td>
<td>~23 minutes</td>
</tr>
<tr>
<td>Node</td>
<td>3.5 minutes</td>
</tr>
<tr>
<td>Crystal</td>
<td>1.1 minutes</td>
</tr>
</tbody>
</table>
<p>And here is the source code used to generate the bechmark data above.</p>
<ul>
<li><a href="/src/fun_with_crystal/loop.js">js</a></li>
<li><a href="/src/fun_with_crystal/loop.rb">ruby/Crystal</a></li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://crystal-lang.org/">Crystal lang</a> official home page</li>
<li>A nice <a href="https://home.deib.polimi.it/matteucc/Clustering/tutorial_html/">introduction to clustering</a></li>
</ul>
<h2 id="heading"></h2>
<p>I hope you enjoyed the read! You can share <em>your</em> experiences with Crystal scripting in the comments section below.</p>
<p>If you'd like to stay in touch, then subscribe or follow me on <a href="https://twitter.com/lbarasti">Twitter</a>.

<link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
	#mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
	 
</style>
<div id="mc_embed_signup">
<form action="https://lbarasti.us4.list-manage.com/subscribe/post?u=2ae02926c5ced578d57958587&amp;id=e952a286b4" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL"></label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_2ae02926c5ced578d57958587_e952a286b4" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

</p>
</div>

  <footer class="article-footer">

    <aside class="share">
  <a href="https://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f&title=Going%20faster%20with%20Crystal" title="はてなブックマーク" class="ht" target="_blank" rel="nofollow">B!</a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f&text=Going%20faster%20with%20Crystal&tw_p=tweetbutton" title="Twitterでシェア" class="tw" target="_blank" rel="nofollow"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f&t=Going%20faster%20with%20Crystal" title="Facebookでシェア" class="fb" target="_blank" rel="nofollow"><i class="fab fa-facebook" aria-hidden="true"></i></a>
  <a href="https://getpocket.com/edit?url=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f&title=Going%20faster%20with%20Crystal" title="Pocketに保存" class="pk" target="_blank" rel="nofollow"><i class="fab fa-get-pocket" aria-hidden="true"></i></a>
  <a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2flbarasti.com%2fpost%2ffun_with_crystal%2f" title="LINEでシェア" class="ln" target="_blank" rel="nofollow"><i class="fab fa-line" aria-hidden="true"></i></a>
</aside>


    <section class="footer">
      <div>
        <nav class="crumb">
          <ol>
            <li><a href="https://lbarasti.com"><i class="fas fa-home" aria-hidden="true"></i>TOP</a></li>
            
            <li itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="https://lbarasti.compost/" itemprop="url"><span itemprop="title">POST</span></a></li>
            
            <li class="active">Going faster with Crystal</li>
          </ol>
        </nav>
      </div>
    </section>

    
    
    
    
    
    <section class="footer">
      <header>
        <a href="https://lbarasti.comtags/">TAGS</a>
      </header>
      <div>
        <ul class="terms">
          
          <li><a href="https://lbarasti.comtags/crystal/">crystal</a></li>
          
          <li><a href="https://lbarasti.comtags/ruby/">ruby</a></li>
          
          <li><a href="https://lbarasti.comtags/algorithms/">algorithms</a></li>
          
        </ul>
      </div>
    </section>
    
    
  </footer>

</article>


    <div class="adj">
      <div class="mrow">
        
        
        <div class="mcol c6">
          <header>Next Article</header>
          <article class="lism">
  <a href="https://lbarasti.com/post/two_way_comm_between_fibers/">
    <div class="thumb thumb-2f8501660be1b202f0622f4169e68f2a"></div>

    <div class="inner">
      <div class="title">2-way communication between Fibers</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="25007-11-25T22:12:33JST">Nov 25, 2019</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

        </div>
        
      </div>
    </div>

    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lbarasti-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
  <div class="mcol c4">
    <aside class="l-sidebar">

  <div class="sections sidebar">
    
<section class="sidebar">
  <header>AUTHOR</header>
  <div>
    <div class="author">
      
      <div class="author-thumb" style="background-image: url(https://lbarasti.com/images/profile-picture.jpg);"></div>
      
      <div class="author-name">Lorenzo Barasti</div>
      <ul class="author-facts">
        
        <li><a href="https://twitter.com/lbarasti" rel="nofollow" target="_blank"><i class="fab fa-twitter" aria-hidden="true"></i></a></li>
        <li><a href="https://github.com/lbarasti" rel="nofollow" target="_blank"><i class="fab fa-github" aria-hidden="true"></i></a></li>
        <li><a href="https://www.youtube.com/channel/UCaydNuV-VSO0gFSrvS9WgXg" rel="nofollow" target="_blank"><i class="fab fa-youtube" aria-hidden="true"></i></a></li>
        <li><a href="https://twitch.tv/lbarasti" rel="nofollow" target="_blank"><i class="fab fa-twitch" aria-hidden="true"></i></a></li>
      </ul>
      <div class="author-description">Exploring concurrency in Crystal, live coding on occasion.</div>
    </div>
  </div>
</section>


    <section class="sidebar">
  <header>LATESTS</header>
  <div>
    <div class="articles sm">
      
      <article class="lism">
  <a href="https://lbarasti.com/post/two_way_comm_between_fibers/">
    <div class="thumb thumb-2f8501660be1b202f0622f4169e68f2a"></div>

    <div class="inner">
      <div class="title">2-way communication between Fibers</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="25007-11-25T22:12:33JST">Nov 25, 2019</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
      <article class="lism">
  <a href="https://lbarasti.com/post/fun_with_crystal/">
    <div class="thumb thumb-a79bcaa63d57a1252d925acc5f4a4d76"></div>

    <div class="inner">
      <div class="title">Going faster with Crystal</div>

      <ul class="facts sm">
        <li><i class="fas fa-calendar" aria-hidden="true"></i><time datetime="12007-04-12T10:12:33JST">Apr 12, 2017</time></li>
        <li><i class="fas fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

      
    </div>
  </div>
</section>

    

    
<section class="sidebar">
  <header>TAGS</header>
  <div>
    <ul class="terms">
      <li><a href="https://lbarasti.comtags/crystal">crystal <span class="count">(2)</span></a></li><li><a href="https://lbarasti.comtags/actor">actor <span class="count">(1)</span></a></li><li><a href="https://lbarasti.comtags/algorithms">algorithms <span class="count">(1)</span></a></li><li><a href="https://lbarasti.comtags/channel">channel <span class="count">(1)</span></a></li><li><a href="https://lbarasti.comtags/concurrency">concurrency <span class="count">(1)</span></a></li><li><a href="https://lbarasti.comtags/fiber">fiber <span class="count">(1)</span></a></li><li><a href="https://lbarasti.comtags/genserver">genserver <span class="count">(1)</span></a></li><li><a href="https://lbarasti.comtags/ruby">ruby <span class="count">(1)</span></a></li><li><a href="https://lbarasti.comtags/server">server <span class="count">(1)</span></a></li>
    </ul>
  </div>
</section>



  </div>

</aside>

  </div>
</div>

      </div>
    </main>

    <footer class="l-footer">
      <div class="l-container">
        <p><span class="h-logo">&copy; lbarasti&#39;s blog</span></p>
        <aside>
          <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
          <p><a href="https://github.com/dim0627/hugo_theme_robust">Robust</a> designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>.</p>
        </aside>
      </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

